<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Inscription & Connexion - Asa En Ligne</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 400px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    h2 { text-align: center; }
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"] {
      width: 100%;
      padding: 10px;
      margin: 5px 0 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      width: 100%;
      padding: 10px;
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #218838; }
    .link { text-align: center; margin-top: 10px; }
    a { color: #007bff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <!-- Section d'inscription -->
  <div id="registration-section" class="container">
    <h2>Inscription</h2>
    <form onsubmit="event.preventDefault(); registerUser();">
      <input type="text" id="full-name" placeholder="Nom complet" required>
      <input type="email" id="email" placeholder="E-mail" required>
      <input type="password" id="password" placeholder="Mot de passe" required>
      <input type="password" id="confirm-password" placeholder="Confirmer mot de passe" required>
      <button type="submit">S'inscrire</button>
    </form>
    <div class="link">
      Déjà un compte ? <a href="#" onclick="showLoginSection()">Connectez-vous</a>
    </div>
  </div>

  <!-- Section de connexion -->
  <div id="login-section" class="container hidden">
    <h2>Connexion</h2>
    <form onsubmit="event.preventDefault(); loginUser();">
      <input type="email" id="login-email" placeholder="E-mail" required>
      <input type="password" id="login-password" placeholder="Mot de passe" required>
      <button type="submit">Se connecter</button>
    </form>
    <div class="link">
      <a href="#" onclick="resetPassword()">Mot de passe oublié ?</a>
    </div>
    <div class="link">
      Pas de compte ? <a href="#" onclick="showRegistrationSection()">S'inscrire</a>
    </div>
  </div>

  <!-- Section d'annonce de paiement -->
  <div id="payment-instructions" class="container hidden">
    <h2>Annonce de Paiement</h2>
    <p>Mila mandoa 1000 Ar isambolana ianao vao hahazo code d'activation.</p>
    <button onclick="proceedToPayment()">D'accord</button>
  </div>

  <!-- Section misy laharana handefasana vola -->
  <div id="payment-numbers" class="container hidden">
    <h2>Envoyer votre paiement</h2>
    <p>Mandefasa vola amin'ireto laharana ireto :</p>
    <ul>
      <li>0323911654 [RAVELOMANANTSOA Urmin]</li>
      <li>0384557584 [BEFOTSY Ranjity]</li>
      <li>0333635111 [RANAIVOSON Angelo]</li>
    </ul>
    <button onclick="showPaymentProofForm()">J'ai payé</button>
  </div>

  <!-- Formulaire de preuve de paiement -->
  <div id="payment-proof" class="container hidden">
    <h2>Preuve de Paiement</h2>
    <input type="text" id="proof-fullname" placeholder="Nom complet" required>
    <input type="text" id="proof-phone" placeholder="NUMERO de téléphone utilisé" required>
    <input type="number" id="proof-amount" placeholder="Montant à payer" required>
    <button onclick="submitPaymentProof()">Envoyer</button>
  </div>

  <!-- Notification "En attente de vérification" -->
  <div id="pending-verification" class="container hidden">
    <h2>En attente de vérification</h2>
    <p>Votre demande de paiement est en attente de vérification par l'administration.</p>
    <p id="timeout-message" class="hidden">
      24h dépassé. Veuillez appeler ou envoyer un message à : 0323911654, 0333635111, 0384557584.
    </p>
  </div>

  <!-- Notification après confirmation par admin -->
  <div id="activation-notification" class="container hidden">
    <h2>Paiement confirmé</h2>
    <p>Votre paiement a été vérifié.<br>
       Voici votre nouveau code d'activation : <span id="user-activation-code"></span>
    </p>
    <button onclick="showActivatedLogin()">Connectez-vous maintenant</button>
  </div>

  <!-- Formulaire de connexion avec activation -->
  <div id="activated-login-section" class="container hidden">
    <h2>Connexion (Activation requise)</h2>
    <form onsubmit="event.preventDefault(); activatedLoginUser();">
      <input type="email" id="activated-login-email" placeholder="E-mail" required>
      <input type="password" id="activated-login-password" placeholder="Mot de passe" required>
      <input type="text" id="activated-login-code" placeholder="Code d'activation" required>
      <button type="submit">Se connecter</button>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, addDoc, collection, updateDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCK4HqGSjYRT2jFNhAvniSWIzhDvEb2qAQ",
      authDomain: "asa-en-ligne.firebaseapp.com",
      projectId: "asa-en-ligne",
      storageBucket: "asa-en-ligne.appspot.com",
      messagingSenderId: "58359363245",
      appId: "1:58359363245:web:ca5969776ce9cd86aef824",
      measurementId: "G-MRVHVWPV71"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Inscription : Tsy mamorona code d'activation aloha, fa manoratra fotsiny ny mombamomba miaraka amin'ny "paymentStatus" "not_paid".
    window.registerUser = function() {
      const fullName = document.getElementById("full-name").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const confirmPassword = document.getElementById("confirm-password").value;
      if(password !== confirmPassword) {
        alert("Les mots de passe ne correspondent pas.");
        return;
      }
      createUserWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          setDoc(doc(db, "users", user.uid), {
            fullName: fullName,
            email: email,
            paymentStatus: "not_paid",
            createdAt: new Date()
          })
          .then(() => {
            alert("Inscription réussie. Veuillez vous connecter.");
            showLoginSection();
          })
          .catch((error) => {
            alert("Erreur lors de l'enregistrement : " + error.message);
          });
        })
        .catch((error) => {
          alert("Erreur : " + error.message);
        });
    };

    // Connexion : Si le compte n'est pas payé, ne montre pas l'ancien code d'activation
    window.loginUser = function() {
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value;
      signInWithEmailAndPassword(auth, email, password)
        .then(async (userCredential) => {
          const user = userCredential.user;
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if(userDoc.exists()){
            const userData = userDoc.data();
            if(userData.paymentStatus === "confirmed"){
              // Si paiement confirmé, afficher le nouveau code d'activation généré par admin
              document.getElementById("activation-notification").classList.remove("hidden");
              document.getElementById("user-activation-code").innerText = userData.activationCode;
            } else if(userData.paymentStatus === "pending"){
              document.getElementById("pending-verification").classList.remove("hidden");
            } else {
              // Si non payé, afficher l'annonce de paiement
              document.getElementById("payment-instructions").classList.remove("hidden");
            }
          } else {
            alert("Aucune donnée utilisateur trouvée.");
          }
        })
        .catch(error => alert("Erreur : " + error.message));
    };

    window.resetPassword = function() {
      const email = document.getElementById("login-email").value.trim();
      if(!email) {
        alert("Veuillez entrer votre adresse e-mail.");
        return;
      }
      sendPasswordResetEmail(auth, email)
        .then(() => alert("Email de réinitialisation envoyé !"))
        .catch((error) => alert("Erreur : " + error.message));
    };

    window.showRegistrationSection = function() {
      document.getElementById("registration-section").style.display = "block";
      document.getElementById("login-section").classList.add("hidden");
    };

    window.showLoginSection = function() {
      document.getElementById("registration-section").style.display = "none";
      document.getElementById("login-section").classList.remove("hidden");
      // Masquer les autres sections
      document.getElementById("payment-instructions").classList.add("hidden");
      document.getElementById("payment-numbers").classList.add("hidden");
      document.getElementById("payment-proof").classList.add("hidden");
      document.getElementById("pending-verification").classList.add("hidden");
      document.getElementById("activation-notification").classList.add("hidden");
      document.getElementById("activated-login-section").classList.add("hidden");
    };

    window.proceedToPayment = function() {
      document.getElementById("payment-instructions").classList.add("hidden");
      document.getElementById("payment-numbers").classList.remove("hidden");
    };

    window.showPaymentProofForm = function() {
      document.getElementById("payment-numbers").classList.add("hidden");
      document.getElementById("payment-proof").classList.remove("hidden");
    };

    // Lorsqu'un utilisateur envoie la preuve de paiement, sa demande est ajoutée et son état passe à "pending"
    window.submitPaymentProof = async function() {
      const proofFullName = document.getElementById("proof-fullname").value.trim();
      const proofPhone = document.getElementById("proof-phone").value.trim();
      const proofAmount = document.getElementById("proof-amount").value.trim();
      if(!proofFullName || !proofPhone || !proofAmount) {
        alert("Veuillez remplir tous les champs.");
        return;
      }
      const paymentData = {
        userId: auth.currentUser.uid,
        fullName: proofFullName,
        phone: proofPhone,
        amount: proofAmount,
        timestamp: new Date().toISOString(),
        status: "pending"
      };
      await addDoc(collection(db, "paymentRequests"), paymentData)
        .then(async () => {
          const userRef = doc(db, "users", auth.currentUser.uid);
          await updateDoc(userRef, { paymentStatus: "pending" });
          alert("Votre demande a été envoyée. En attente de vérification.");
          document.getElementById("payment-proof").classList.add("hidden");
          document.getElementById("pending-verification").classList.remove("hidden");
        })
        .catch((error) => alert("Erreur lors de l'envoi : " + error.message));
    };

    window.showActivatedLogin = function() {
      document.getElementById("activation-notification").classList.add("hidden");
      document.getElementById("activated-login-section").classList.remove("hidden");
    };

    window.activatedLoginUser = function() {
      const email = document.getElementById("activated-login-email").value.trim();
      const password = document.getElementById("activated-login-password").value;
      const activationCode = document.getElementById("activated-login-code").value.trim();
      signInWithEmailAndPassword(auth, email, password)
        .then(async (userCredential) => {
          const user = userCredential.user;
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if(userDoc.exists()){
            const userData = userDoc.data();
            if(userData.activationCode === activationCode) {
              alert("Connexion réussie ! Redirection...");
              window.location.href = "https://site-web-asa-en-ligne-m-da-1-zhdm.vercel.app/";
            } else {
              alert("Code d'activation incorrect.");
            }
          }
        })
        .catch(error => alert("Erreur : " + error.message));
    };
  </script>
</body>
</html>
